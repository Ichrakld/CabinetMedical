@* Partial View: _NotificationDropdown.cshtml *@
@* Usage: Place this in your _Layout.cshtml navbar *@

<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle position-relative" href="#" id="notificationDropdown"
       role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-bell"></i>
        <span id="notification-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              style="display: none; font-size: 0.65rem;">
            0
        </span>
    </a>
    <div class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationDropdown"
         style="min-width: 350px; max-height: 400px;">
        <div class="dropdown-header d-flex justify-content-between align-items-center py-2 px-3">
            <h6 class="mb-0 fw-bold">Notifications</h6>
            <a href="#" id="markAllReadDropdown" class="text-primary text-decoration-none small">
                <i class="fas fa-check-double"></i> Tout marquer lu
            </a>
        </div>
        <div class="dropdown-divider my-0"></div>
        <div id="notification-list" style="max-height: 300px; overflow-y: auto;">
            <div class="text-center py-4">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
            </div>
        </div>
        <div class="dropdown-divider my-0"></div>
        <a class="dropdown-item text-center py-2" asp-controller="Notifications" asp-action="Index">
            <i class="fas fa-list me-1"></i>Voir toutes les notifications
        </a>
    </div>
</li>

<style>
    .notification-dropdown {
        padding: 0;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .notification-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item.unread {
            background-color: #e3f2fd;
            border-left: 3px solid #2196F3;
        }

        .notification-item .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .notification-item .notification-icon.rappel {
                background-color: #fff3cd;
                color: #856404;
            }

            .notification-item .notification-icon.confirmation {
                background-color: #d4edda;
                color: #155724;
            }

            .notification-item .notification-icon.annulation {
                background-color: #f8d7da;
                color: #721c24;
            }

            .notification-item .notification-icon.succes {
                background-color: #d4edda;
                color: #155724;
            }

            .notification-item .notification-icon.erreur {
                background-color: #f8d7da;
                color: #721c24;
            }

            .notification-item .notification-icon.info {
                background-color: #d1ecf1;
                color: #0c5460;
            }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Charger le compteur initial
        loadNotificationCount();

        // Charger les notifications au clic sur le dropdown
        document.getElementById('notificationDropdown').addEventListener('click', function(e) {
            loadRecentNotifications();
        });

        // Marquer tout comme lu depuis le dropdown
        document.getElementById('markAllReadDropdown').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            fetch('/Notifications/MarkAllAsRead', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadNotificationCount();
                        loadRecentNotifications();
                    }
                });
        });

        // Rafraîchir toutes les 30 secondes
        setInterval(loadNotificationCount, 30000);
    });

    function loadNotificationCount() {
        fetch('/Notifications/GetUnreadCount')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('notification-badge');
                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            })
            .catch(err => console.error('Erreur chargement notifications:', err));
    }

    function loadRecentNotifications() {
        const listContainer = document.getElementById('notification-list');

        fetch('/Notifications/GetRecent')
            .then(response => response.json())
            .then(notifications => {
                if (notifications.length === 0) {
                    listContainer.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-bell-slash fa-2x mb-2"></i>
                            <p class="mb-0">Aucune notification</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                notifications.forEach(notif => {
                    const iconClass = getNotificationIcon(notif.type);
                    const iconBgClass = getNotificationIconBg(notif.type);

                    html += `
                        <div class="notification-item ${notif.estLue ? '' : 'unread'}" data-id="${notif.id}">
                            <div class="d-flex align-items-start">
                                <div class="notification-icon ${iconBgClass} me-3">
                                    <i class="fas ${iconClass}"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <span class="badge bg-secondary mb-1">${notif.type}</span>
                                        <small class="text-muted">${notif.dateCreation}</small>
                                    </div>
                                    <p class="mb-0 small text-truncate" style="max-width: 250px;">
                                        ${notif.message}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                listContainer.innerHTML = html;

                // Ajouter les événements de clic
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const id = this.dataset.id;
                        markAsRead(id, this);
                    });
                });
            })
            .catch(err => {
                console.error('Erreur:', err);
                listContainer.innerHTML = `
                    <div class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p class="mb-0">Erreur de chargement</p>
                    </div>
                `;
            });
    }

    function markAsRead(id, element) {
        fetch('/Notifications/MarkAsRead/' + id, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    element.classList.remove('unread');
                    loadNotificationCount();
                }
            });
    }

    function getNotificationIcon(type) {
        switch (type) {
            case 'Rappel RDV': return 'fa-clock';
            case 'Confirmation': return 'fa-check-circle';
            case 'Annulation': return 'fa-times-circle';
            case 'Succès': return 'fa-check';
            case 'Erreur': return 'fa-exclamation-triangle';
            default: return 'fa-info-circle';
        }
    }

    function getNotificationIconBg(type) {
        switch (type) {
            case 'Rappel RDV': return 'rappel';
            case 'Confirmation': return 'confirmation';
            case 'Annulation': return 'annulation';
            case 'Succès': return 'succes';
            case 'Erreur': return 'erreur';
            default: return 'info';
        }
    }
</script>
