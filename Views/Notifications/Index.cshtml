@model IEnumerable<GestionCabinetMedical.Models.Notification>

@{
    ViewData["Title"] = "Notifications";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-bell text-primary me-2"></i>Mes Notifications
        </h2>
        <div>
            @if (Model.Any(n => !n.EstLue))
            {
                <button id="btnMarkAllRead" class="btn btn-outline-primary">
                    <i class="fas fa-check-double me-1"></i>Tout marquer comme lu
                </button>
            }
        </div>
    </div>

    <!-- Filtres -->
    <div class="card shadow-sm mb-4">
        <div class="card-body py-3">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="filterStatus" id="filterAll" value="all" checked>
                        <label class="btn btn-outline-secondary" for="filterAll">Toutes</label>

                        <input type="radio" class="btn-check" name="filterStatus" id="filterUnread" value="unread">
                        <label class="btn btn-outline-secondary" for="filterUnread">Non lues</label>

                        <input type="radio" class="btn-check" name="filterStatus" id="filterRead" value="read">
                        <label class="btn btn-outline-secondary" for="filterRead">Lues</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <select id="filterType" class="form-select">
                        <option value="">Tous les types</option>
                        <option value="Rappel RDV">Rappel RDV</option>
                        <option value="Confirmation">Confirmation</option>
                        <option value="Annulation">Annulation</option>
                        <option value="Succès">Succès</option>
                        <option value="Erreur">Erreur</option>
                    </select>
                </div>
                <div class="col-md-4 text-end">
                    <span class="text-muted">
                        <span id="notifCount">@Model.Count()</span> notification(s)
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des notifications -->
    <div id="notificationsList">
        @if (!Model.Any())
        {
            <div class="text-center py-5">
                <i class="fas fa-bell-slash fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">Aucune notification</h5>
                <p class="text-muted">Vous n'avez pas de notifications pour le moment.</p>
            </div>
        }
        else
        {
            foreach (var notification in Model)
            {
                var iconClass = notification.Type switch
                {
                    "Rappel RDV" => "fa-clock text-warning",
                    "Confirmation" => "fa-check-circle text-success",
                    "Annulation" => "fa-times-circle text-danger",
                    "Succès" => "fa-check text-success",
                    "Erreur" => "fa-exclamation-triangle text-danger",
                    _ => "fa-info-circle text-info"
                };

                var bgClass = notification.EstLue ? "" : "bg-light border-start border-primary border-4";

                <div class="card notification-card mb-2 @bgClass"
                     data-id="@notification.Id"
                     data-type="@notification.Type"
                     data-read="@notification.EstLue.ToString().ToLower()">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-start">
                            <div class="notification-icon me-3">
                                <i class="fas @iconClass fa-lg"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="badge bg-secondary me-2">@notification.Type</span>
                                        @if (!notification.EstLue)
                                        {
                                            <span class="badge bg-primary">Nouveau</span>
                                        }
                                    </div>
                                    <small class="text-muted">
                                        <i class="far fa-clock me-1"></i>
                                        @notification.DateCreation.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </div>
                                <p class="mb-2 mt-2">@notification.Message</p>
                                <div class="notification-actions">
                                    @if (!notification.EstLue)
                                    {
                                        <button class="btn btn-sm btn-outline-primary btn-mark-read" data-id="@notification.Id">
                                            <i class="fas fa-check me-1"></i>Marquer comme lu
                                        </button>
                                    }
                                    <button class="btn btn-sm btn-outline-danger btn-delete" data-id="@notification.Id">
                                        <i class="fas fa-trash me-1"></i>Supprimer
                                    </button>
                                    @if (notification.RendezVousId.HasValue)
                                    {
                                        <a href="@Url.Action("Details", "RendezVous", new { id = notification.RendezVousId })"
                                           class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-eye me-1"></i>Voir RDV
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Marquer comme lu
            $('.btn-mark-read').click(function() {
                var id = $(this).data('id');
                var card = $(this).closest('.notification-card');

                $.post('/Notifications/MarkAsRead/' + id, function(response) {
                    if (response.success) {
                        card.removeClass('bg-light border-start border-primary border-4');
                        card.find('.badge.bg-primary').remove();
                        card.find('.btn-mark-read').remove();
                        card.attr('data-read', 'true');
                        updateNotificationBadge();
                        showToast('Notification marquée comme lue', 'success');
                    }
                });
            });

            // Supprimer
            $('.btn-delete').click(function() {
                var id = $(this).data('id');
                var card = $(this).closest('.notification-card');

                if (confirm('Supprimer cette notification ?')) {
                    $.post('/Notifications/Delete/' + id, function(response) {
                        if (response.success) {
                            card.fadeOut(300, function() {
                                $(this).remove();
                                updateNotifCount();
                                updateNotificationBadge();
                            });
                            showToast('Notification supprimée', 'success');
                        }
                    });
                }
            });

            // Tout marquer comme lu
            $('#btnMarkAllRead').click(function() {
                $.post('/Notifications/MarkAllAsRead', function(response) {
                    if (response.success) {
                        $('.notification-card').removeClass('bg-light border-start border-primary border-4');
                        $('.badge.bg-primary').remove();
                        $('.btn-mark-read').remove();
                        $('.notification-card').attr('data-read', 'true');
                        $('#btnMarkAllRead').hide();
                        updateNotificationBadge();
                        showToast('Toutes les notifications marquées comme lues', 'success');
                    }
                });
            });

            // Filtres
            $('input[name="filterStatus"]').change(filterNotifications);
            $('#filterType').change(filterNotifications);

            function filterNotifications() {
                var statusFilter = $('input[name="filterStatus"]:checked').val();
                var typeFilter = $('#filterType').val();

                $('.notification-card').each(function() {
                    var card = $(this);
                    var isRead = card.attr('data-read') === 'true';
                    var type = card.attr('data-type');

                    var showByStatus = statusFilter === 'all' ||
                                       (statusFilter === 'unread' && !isRead) ||
                                       (statusFilter === 'read' && isRead);

                    var showByType = !typeFilter || type === typeFilter;

                    if (showByStatus && showByType) {
                        card.show();
                    } else {
                        card.hide();
                    }
                });

                updateNotifCount();
            }

            function updateNotifCount() {
                var visibleCount = $('.notification-card:visible').length;
                $('#notifCount').text(visibleCount);
            }

            function updateNotificationBadge() {
                $.get('/Notifications/GetUnreadCount', function(response) {
                    var badge = $('#notification-badge');
                    if (response.count > 0) {
                        badge.text(response.count).show();
                    } else {
                        badge.hide();
                    }
                });
            }

            function showToast(message, type) {
                // Si vous avez un système de toast
                if (typeof toastr !== 'undefined') {
                    toastr[type](message);
                }
            }
        });
    </script>
}
