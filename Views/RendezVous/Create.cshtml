@model GestionCabinetMedical.Models.RendezVou

@{
    ViewData["Title"] = "Nouveau Rendez-vous";
}

<style>
    .form-card {
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        background: white;
    }

    .form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 15px 15px 0 0;
    }

    .conflict-warning {
        display: none;
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }

        .conflict-warning.show {
            display: block;
        }
</style>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="form-card">
                <div class="form-header">
                    <h3 class="mb-0"><i class="fas fa-calendar-plus me-2"></i>Nouveau Rendez-vous</h3>
                </div>

                <div class="card-body p-4">
                    <form asp-action="Create" id="rdvForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <div id="conflictWarning" class="conflict-warning">
                            <h6><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Attention - Conflit détecté</h6>
                            <p id="conflictMessage" class="mb-0"></p>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="DateHeure" class="form-label">
                                    <i class="fas fa-calendar text-primary me-1"></i>Date et Heure <span class="text-danger">*</span>
                                </label>
                                <input asp-for="DateHeure" type="datetime-local" class="form-control form-control-lg"
                                       id="dateHeureInput" min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                                <span asp-validation-for="DateHeure" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Statut" class="form-label">
                                    <i class="fas fa-info-circle text-primary me-1"></i>Statut
                                </label>
                                <select asp-for="Statut" class="form-select form-select-lg">
                                    <option value="En attente">En attente</option>
                                    <option value="Confirmé">Confirmé</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="MedecinId" class="form-label">
                                    <i class="fas fa-user-md text-primary me-1"></i>Médecin <span class="text-danger">*</span>
                                </label>
                                <select asp-for="MedecinId" class="form-select form-select-lg" asp-items="ViewBag.MedecinId" id="medecinSelect">
                                    <option value="">-- Sélectionner un médecin --</option>
                                </select>
                                <span asp-validation-for="MedecinId" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="PatientId" class="form-label">
                                    <i class="fas fa-user text-primary me-1"></i>Patient <span class="text-danger">*</span>
                                </label>
                                <select asp-for="PatientId" class="form-select form-select-lg" asp-items="ViewBag.PatientId" id="patientSelect">
                                    <option value="">-- Sélectionner un patient --</option>
                                </select>
                                <span asp-validation-for="PatientId" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Motif" class="form-label">
                                <i class="fas fa-comment-medical text-primary me-1"></i>Motif de consultation
                            </label>
                            <textarea asp-for="Motif" class="form-control" rows="3" placeholder="Décrivez brièvement le motif..."></textarea>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Index" class="btn btn-secondary btn-lg"><i class="fas fa-arrow-left me-1"></i>Annuler</a>
                            <div>
                                <a asp-action="Calendrier" class="btn btn-outline-info btn-lg me-2"><i class="fas fa-calendar"></i> Calendrier</a>
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn"><i class="fas fa-save me-1"></i>Créer</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function() {
            function checkConflict() {
                var medecinId = $('#medecinSelect').val();
                var patientId = $('#patientSelect').val();
                var dateHeure = $('#dateHeureInput').val();

                if (medecinId && patientId && dateHeure) {
                    $.post('@Url.Action("CheckConflict")', {
                        medecinId: medecinId, patientId: patientId, dateHeure: dateHeure
                    }, function(response) {
                        if (response.hasConflict) {
                            $('#conflictMessage').text(response.message);
                            $('#conflictWarning').addClass('show');
                            $('#submitBtn').prop('disabled', true).addClass('btn-secondary').removeClass('btn-primary');
                        } else {
                            $('#conflictWarning').removeClass('show');
                            $('#submitBtn').prop('disabled', false).addClass('btn-primary').removeClass('btn-secondary');
                        }
                    });
                }
            }
            $('#medecinSelect, #patientSelect, #dateHeureInput').on('change', checkConflict);
        });
    </script>
}
