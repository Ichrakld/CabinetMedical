@{
    ViewData["Title"] = "Calendrier des Rendez-vous";
    var isPatient = (bool)(ViewBag.IsPatient ?? false);
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-calendar-alt text-primary me-2"></i>Calendrier des Rendez-vous
            @if (isPatient)
            {
                <span class="badge bg-info ms-2">Mes rendez-vous</span>
            }
        </h2>
        <div>
            <a asp-action="Index" class="btn btn-outline-secondary me-2">
                <i class="fas fa-list"></i> Vue Liste
            </a>
            @if (!isPatient)
            {
                <a asp-action="Create" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nouveau RDV
                </a>
            }
        </div>
    </div>

    @if (!isPatient)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label"><i class="fas fa-user-md me-1"></i>Médecin</label>
                        <select id="filterMedecin" class="form-select">
                            <option value="">Tous les médecins</option>
                            @foreach (var m in ViewBag.Medecins)
                            {
                                <option value="@m.Id">@m.Nom</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label"><i class="fas fa-filter me-1"></i>Statut</label>
                        <select id="filterStatut" class="form-select">
                            <option value="">Tous les statuts</option>
                            <option value="En attente">En attente</option>
                            <option value="Confirmé">Confirmé</option>
                            <option value="Annulé">Annulé</option>
                            <option value="Terminé">Terminé</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button id="btnResetFilters" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-undo"></i> Réinitialiser
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="mb-3">
        <span class="badge bg-warning text-dark me-2"><i class="fas fa-clock"></i> En attente</span>
        <span class="badge bg-success me-2"><i class="fas fa-check"></i> Confirmé</span>
        <span class="badge bg-danger me-2"><i class="fas fa-times"></i> Annulé</span>
        <span class="badge bg-info me-2"><i class="fas fa-check-double"></i> Terminé</span>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="rdvModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">
                <h5 class="modal-title"><i class="fas fa-calendar-check me-2"></i>Détails du Rendez-vous</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="text-muted small">Date et Heure</label>
                    <p class="fs-5 fw-bold text-primary" id="modalDateTime"></p>
                </div>
                <div class="row">
                    <div class="col-6">
                        <label class="text-muted small">Patient</label>
                        <p class="fw-bold" id="modalPatient"></p>
                    </div>
                    <div class="col-6">
                        <label class="text-muted small">Médecin</label>
                        <p class="fw-bold" id="modalMedecin"></p>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="text-muted small">Spécialité</label>
                    <p id="modalSpecialite"></p>
                </div>
                <div class="mb-3">
                    <label class="text-muted small">Motif</label>
                    <p id="modalMotif" class="fst-italic"></p>
                </div>
                <div class="mb-3">
                    <label class="text-muted small">Statut</label>
                    <p><span id="modalStatut" class="badge fs-6"></span></p>
                </div>
            </div>
            <div class="modal-footer" id="modalFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <a id="btnDetails" href="#" class="btn btn-info"><i class="fas fa-eye"></i> Voir</a>
                @if (!isPatient)
                {
                    <a id="btnEdit" href="#" class="btn btn-warning"><i class="fas fa-edit"></i> Modifier</a>
                    <button id="btnConfirm" class="btn btn-success"><i class="fas fa-check"></i> Confirmer</button>
                    <button id="btnCancel" class="btn btn-danger"><i class="fas fa-times"></i> Annuler</button>
                }
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
    <style>
        #calendar {
            min-height: 700px;
        }

        .fc-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 5px;
            font-size: 0.85rem;
        }

            .fc-event:hover {
                opacity: 0.9;
                transform: scale(1.02);
                transition: all 0.2s;
            }

        .fc-daygrid-day-number {
            font-weight: 600;
        }

        .fc-day-today {
            background-color: rgba(102, 126, 234, 0.1) !important;
        }

        .fc-toolbar-title {
            font-size: 1.5rem !important;
            font-weight: 600;
        }

        .modal-header.status-confirmed {
            background-color: #28a745;
            color: white;
        }

        .modal-header.status-pending {
            background-color: #ffc107;
            color: #212529;
        }

        .modal-header.status-cancelled {
            background-color: #dc3545;
            color: white;
        }

        .modal-header.status-completed {
            background-color: #17a2b8;
            color: white;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/fr.global.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var currentRdvId = null;
            var isPatient = @(isPatient ? "true" : "false");

            var calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'fr',
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                buttonText: { today: "Aujourd'hui", month: 'Mois', week: 'Semaine', day: 'Jour', list: 'Liste' },
                navLinks: true,
                editable: false,
                selectable: !isPatient,
                selectMirror: true,
                dayMaxEvents: 3,
                weekNumbers: true,
                nowIndicator: true,
                slotMinTime: '08:00:00',
                slotMaxTime: '20:00:00',
                allDaySlot: false,
                slotDuration: '00:30:00',

                events: function(info, successCallback, failureCallback) {
                    var medecinId = document.getElementById('filterMedecin')?.value || '';
                    var status = document.getElementById('filterStatut')?.value || '';
                    var url = '@Url.Action("GetCalendarEvents")' + '?start=' + info.startStr + '&end=' + info.endStr;
                    if (medecinId) url += '&medecinId=' + medecinId;
                    if (status) url += '&status=' + encodeURIComponent(status);

                    fetch(url).then(r => r.json()).then(data => successCallback(data)).catch(e => failureCallback(e));
                },

                eventClick: function(info) {
                    var event = info.event;
                    var props = event.extendedProps;
                    currentRdvId = event.id;

                    var startDate = new Date(event.start);
                    document.getElementById('modalDateTime').textContent = startDate.toLocaleDateString('fr-FR', {
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });

                    document.getElementById('modalPatient').textContent = props.patient || '-';
                    document.getElementById('modalMedecin').textContent = props.medecin || '-';
                    document.getElementById('modalSpecialite').textContent = props.specialite || '-';
                    document.getElementById('modalMotif').textContent = props.motif || 'Non spécifié';

                    var statutBadge = document.getElementById('modalStatut');
                    var modalHeader = document.getElementById('modalHeader');
                    modalHeader.className = 'modal-header';
                    statutBadge.className = 'badge fs-6';

                    switch(props.statut) {
                        case 'Confirmé': statutBadge.classList.add('bg-success'); modalHeader.classList.add('status-confirmed'); break;
                        case 'En attente': statutBadge.classList.add('bg-warning', 'text-dark'); modalHeader.classList.add('status-pending'); break;
                        case 'Annulé': statutBadge.classList.add('bg-danger'); modalHeader.classList.add('status-cancelled'); break;
                        case 'Terminé': statutBadge.classList.add('bg-info'); modalHeader.classList.add('status-completed'); break;
                        default: statutBadge.classList.add('bg-secondary');
                    }
                    statutBadge.textContent = props.statut || 'Inconnu';

                    document.getElementById('btnDetails').href = '/RendezVous/Details/' + currentRdvId;

                    if (!isPatient) {
                        document.getElementById('btnEdit').href = '/RendezVous/Edit/' + currentRdvId;
                        var btnConfirm = document.getElementById('btnConfirm');
                        var btnCancel = document.getElementById('btnCancel');

                        if (props.statut === 'En attente') { btnConfirm.style.display = 'inline-block'; btnCancel.style.display = 'inline-block'; }
                        else if (props.statut === 'Confirmé') { btnConfirm.style.display = 'none'; btnCancel.style.display = 'inline-block'; }
                        else { btnConfirm.style.display = 'none'; btnCancel.style.display = 'none'; }
                    }

                    new bootstrap.Modal(document.getElementById('rdvModal')).show();
                },

                select: function(info) {
                    if (!isPatient) {
                        var date = info.start.toISOString().slice(0, 16);
                        window.location.href = '/RendezVous/Create?dateHeure=' + date;
                    }
                },

                eventDidMount: function(info) {
                    var props = info.event.extendedProps;
                    info.el.title = props.patient + ' - ' + props.medecin + ' (' + props.statut + ')';
                }
            });

            calendar.render();

            var filterMedecin = document.getElementById('filterMedecin');
            var filterStatut = document.getElementById('filterStatut');
            if (filterMedecin) filterMedecin.addEventListener('change', () => calendar.refetchEvents());
            if (filterStatut) filterStatut.addEventListener('change', () => calendar.refetchEvents());
            document.getElementById('btnResetFilters')?.addEventListener('click', function() {
                if (filterMedecin) filterMedecin.value = '';
                if (filterStatut) filterStatut.value = '';
                calendar.refetchEvents();
            });

            if (!isPatient) {
                document.getElementById('btnConfirm')?.addEventListener('click', function() {
                    if (currentRdvId && confirm('Confirmer ce rendez-vous ?')) {
                        fetch('/RendezVous/ConfirmRdv/' + currentRdvId, { method: 'POST' })
                            .then(r => r.json()).then(data => {
                                if (data.success) {
                                    bootstrap.Modal.getInstance(document.getElementById('rdvModal')).hide();
                                    calendar.refetchEvents();
                                }
                            });
                    }
                });

                document.getElementById('btnCancel')?.addEventListener('click', function() {
                    var raison = prompt('Raison de l\'annulation (optionnel):');
                    if (currentRdvId) {
                        fetch('/RendezVous/CancelRdv/' + currentRdvId + '?raison=' + encodeURIComponent(raison || ''), { method: 'POST' })
                            .then(r => r.json()).then(data => {
                                if (data.success) {
                                    bootstrap.Modal.getInstance(document.getElementById('rdvModal')).hide();
                                    calendar.refetchEvents();
                                }
                            });
                    }
                });
            }
        });
    </script>
}
