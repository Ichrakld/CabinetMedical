@{
    ViewData["Title"] = "Calendrier des Rendez-vous";
    var isPatient = ViewBag.IsPatient ?? false;
}

<style>
    .calendar-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        padding: 20px;
    }

    /* FullCalendar Custom Styles */
    .fc {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 600 !important;
        color: #333;
    }

    .fc-button-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none !important;
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3) !important;
    }

    .fc-button-primary:hover {
        background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%) !important;
    }

    .fc-button-primary:disabled {
        opacity: 0.6;
    }

    .fc-button-active {
        background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%) !important;
    }

    .fc-day-today {
        background-color: rgba(102, 126, 234, 0.1) !important;
    }

    .fc-event {
        border: none !important;
        border-radius: 5px !important;
        padding: 2px 6px !important;
        font-size: 0.8rem !important;
        cursor: pointer;
        margin-bottom: 2px !important;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .fc-event:hover {
        transform: scale(1.02);
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        z-index: 100 !important;
    }

    .fc-daygrid-event-dot {
        display: none;
    }

    .fc-timegrid-event {
        border-radius: 5px !important;
    }

    /* Legend */
    .calendar-legend {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 5px;
    }

    /* Filters */
    .calendar-filters {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }

    /* Quick Stats */
    .calendar-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-box {
        background: white;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border-left: 4px solid;
    }

    .stat-box.today { border-left-color: #667eea; }
    .stat-box.week { border-left-color: #28a745; }
    .stat-box.pending { border-left-color: #ffc107; }
    .stat-box.confirmed { border-left-color: #17a2b8; }

    .stat-box h3 {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0;
    }

    .stat-box p {
        margin: 0;
        color: #666;
        font-size: 0.8rem;
    }

    /* Modal */
    .rdv-modal-header {
        color: white;
        border-radius: 0;
    }

    .rdv-detail-row {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #eee;
    }

    .rdv-detail-row:last-child {
        border-bottom: none;
    }

    .rdv-detail-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1rem;
    }

    .rdv-detail-content strong {
        display: block;
        color: #333;
        font-size: 0.85rem;
        margin-bottom: 2px;
    }

    .rdv-detail-content span {
        color: #555;
        font-size: 1rem;
    }

    /* Loading overlay */
    .calendar-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 15px;
    }

    .calendar-loading.hidden {
        display: none;
    }
</style>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-calendar-alt text-primary me-2"></i>Calendrier des Rendez-vous
            </h2>
            <p class="text-muted mb-0">
                @if (isPatient)
                {
                    <text>Visualisez vos rendez-vous</text>
                }
                else
                {
                    <text>Visualisez et gérez tous les rendez-vous du cabinet</text>
                }
            </p>
        </div>
        <div class="btn-group">
            <a asp-action="Index" class="btn btn-outline-primary">
                <i class="fas fa-list me-1"></i>Liste
            </a>
            @if (!isPatient)
            {
                <a asp-action="Create" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Nouveau RDV
                </a>
            }
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="calendar-stats" id="calendarStats">
        <div class="stat-box today">
            <h3 id="stat-today">-</h3>
            <p>Aujourd'hui</p>
        </div>
        <div class="stat-box week">
            <h3 id="stat-week">-</h3>
            <p>Cette semaine</p>
        </div>
        <div class="stat-box pending">
            <h3 id="stat-pending">-</h3>
            <p>En attente</p>
        </div>
        <div class="stat-box confirmed">
            <h3 id="stat-confirmed">-</h3>
            <p>Confirmés</p>
        </div>
    </div>

    <!-- Filtres (masqués pour les patients) -->
    @if (!isPatient && ViewBag.Medecins != null)
    {
        <div class="calendar-filters">
            <div class="row align-items-end">
                <div class="col-md-4 mb-2 mb-md-0">
                    <label class="form-label small text-muted mb-1">Filtrer par médecin</label>
                    <select id="filterMedecin" class="form-select">
                        <option value="">Tous les médecins</option>
                        @foreach (var medecin in (IEnumerable<dynamic>)ViewBag.Medecins)
                        {
                            <option value="@medecin.Id">@medecin.Nom</option>
                        }
                    </select>
                </div>
                <div class="col-md-4 mb-2 mb-md-0">
                    <label class="form-label small text-muted mb-1">Filtrer par statut</label>
                    <select id="filterStatut" class="form-select">
                        <option value="">Tous les statuts</option>
                        <option value="En attente">En attente</option>
                        <option value="Confirmé">Confirmé</option>
                        <option value="Annulé">Annulé</option>
                        <option value="Terminé">Terminé</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                        <i class="fas fa-redo me-1"></i>Réinitialiser
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Legend -->
    <div class="calendar-legend">
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ffc107;"></div>
            <span>En attente</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #28a745;"></div>
            <span>Confirmé</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #dc3545;"></div>
            <span>Annulé</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #17a2b8;"></div>
            <span>Terminé</span>
        </div>
    </div>

    <!-- Calendar -->
    <div class="calendar-container position-relative">
        <div class="calendar-loading" id="calendarLoading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        </div>
        <div id="calendar"></div>
    </div>
</div>

<!-- Modal Détails RDV -->
<div class="modal fade" id="rdvModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header rdv-modal-header" id="modalHeader" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-check me-2"></i>Détails du Rendez-vous
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body p-0">
                <div class="rdv-detail-row">
                    <div class="rdv-detail-icon bg-primary bg-opacity-10 text-primary">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="rdv-detail-content">
                        <strong>Date et Heure</strong>
                        <span id="modalDateTime">-</span>
                    </div>
                </div>

                <div class="rdv-detail-row">
                    <div class="rdv-detail-icon bg-success bg-opacity-10 text-success">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="rdv-detail-content">
                        <strong>Patient</strong>
                        <span id="modalPatient">-</span>
                    </div>
                </div>

                <div class="rdv-detail-row">
                    <div class="rdv-detail-icon bg-info bg-opacity-10 text-info">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <div class="rdv-detail-content">
                        <strong>Médecin</strong>
                        <span id="modalMedecin">-</span>
                        <br><small class="text-muted" id="modalSpecialite"></small>
                    </div>
                </div>

                <div class="rdv-detail-row">
                    <div class="rdv-detail-icon bg-warning bg-opacity-10 text-warning">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="rdv-detail-content">
                        <strong>Statut</strong>
                        <span id="modalStatut">-</span>
                    </div>
                </div>

                <div class="rdv-detail-row">
                    <div class="rdv-detail-icon bg-secondary bg-opacity-10 text-secondary">
                        <i class="fas fa-comment-medical"></i>
                    </div>
                    <div class="rdv-detail-content">
                        <strong>Motif</strong>
                        <span id="modalMotif">-</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Fermer
                </button>
                @if (!isPatient)
                {
                    <a href="#" id="btnEditRdv" class="btn btn-primary">
                        <i class="fas fa-edit me-1"></i>Modifier
                    </a>
                }
                <a href="#" id="btnDetailsRdv" class="btn btn-info">
                    <i class="fas fa-eye me-1"></i>Voir détails
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- FullCalendar 6 -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var loadingEl = document.getElementById('calendarLoading');
            var rdvModal = new bootstrap.Modal(document.getElementById('rdvModal'));
            var allEvents = [];

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                firstDay: 1,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                buttonText: {
                    today: "Aujourd'hui",
                    month: 'Mois',
                    week: 'Semaine',
                    day: 'Jour',
                    list: 'Liste'
                },
                navLinks: true,
                editable: false,
                selectable: false,
                dayMaxEvents: 3,
                moreLinkText: function(num) {
                    return '+' + num + ' autres';
                },
                weekNumbers: true,
                weekNumberTitle: 'S',
                slotMinTime: '08:00:00',
                slotMaxTime: '20:00:00',
                allDaySlot: false,
                slotDuration: '00:30:00',
                height: 'auto',

                // ========== CHARGEMENT DES ÉVÉNEMENTS ==========
                events: function(info, successCallback, failureCallback) {
                    loadingEl.classList.remove('hidden');

                    var params = new URLSearchParams({
                        start: info.startStr,
                        end: info.endStr
                    });

                    var medecinFilter = document.getElementById('filterMedecin');
                    var statutFilter = document.getElementById('filterStatut');

                    if (medecinFilter && medecinFilter.value) {
                        params.append('medecinId', medecinFilter.value);
                    }
                    if (statutFilter && statutFilter.value) {
                        params.append('status', statutFilter.value);
                    }

                    fetch('/RendezVous/GetCalendarEvents?' + params.toString())
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erreur réseau');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('📅 Événements chargés:', data.length);
                            allEvents = data;
                            updateStats(data);
                            successCallback(data);
                            loadingEl.classList.add('hidden');
                        })
                        .catch(error => {
                            console.error('❌ Erreur chargement événements:', error);
                            failureCallback(error);
                            loadingEl.classList.add('hidden');
                        });
                },

                // ========== CLIC SUR UN ÉVÉNEMENT ==========
                eventClick: function(info) {
                    var event = info.event;
                    var props = event.extendedProps;

                    document.getElementById('modalDateTime').textContent = formatDate(event.start);
                    document.getElementById('modalPatient').textContent = props.patient || '-';
                    document.getElementById('modalMedecin').textContent = props.medecin || '-';
                    document.getElementById('modalSpecialite').textContent = props.specialite || '';
                    document.getElementById('modalMotif').textContent = props.motif || 'Non spécifié';

                    var statutHtml = getStatusBadge(props.statut);
                    document.getElementById('modalStatut').innerHTML = statutHtml;

                    var headerColors = {
                        'En attente': 'linear-gradient(135deg, #f6d365 0%, #fda085 100%)',
                        'Confirmé': 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                        'Annulé': 'linear-gradient(135deg, #eb3349 0%, #f45c43 100%)',
                        'Terminé': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
                    };
                    document.getElementById('modalHeader').style.background =
                        headerColors[props.statut] || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

                    var btnEdit = document.getElementById('btnEditRdv');
                    var btnDetails = document.getElementById('btnDetailsRdv');

                    if (btnEdit) {
                        btnEdit.href = '/RendezVous/Edit/' + event.id;
                    }
                    if (btnDetails) {
                        btnDetails.href = '/RendezVous/Details/' + event.id;
                    }

                    rdvModal.show();
                },

                @if (!isPatient)
                {
                        <text>
                    dateClick: function(info) {
                        if (confirm('Créer un nouveau rendez-vous le ' + formatDateShort(info.date) + ' ?')) {
                            window.location.href = '/RendezVous/Create?date=' + info.dateStr;
                        }
                    },
                        </text>
                }

                eventDidMount: function(info) {
                    var props = info.event.extendedProps;
                    var tooltipText = props.patient + '\n' +
                                     props.medecin + '\n' +
                                     'Statut: ' + props.statut;
                    if (props.motif && props.motif !== 'Non spécifié') {
                        tooltipText += '\nMotif: ' + props.motif;
                    }
                    info.el.setAttribute('title', tooltipText);
                },

                loading: function(isLoading) {
                    if (isLoading) {
                        loadingEl.classList.remove('hidden');
                    } else {
                        loadingEl.classList.add('hidden');
                    }
                }
            });

            calendar.render();

            // ========== FILTRES ==========
            var filterMedecin = document.getElementById('filterMedecin');
            var filterStatut = document.getElementById('filterStatut');

            if (filterMedecin) {
                filterMedecin.addEventListener('change', function() {
                    calendar.refetchEvents();
                });
            }

            if (filterStatut) {
                filterStatut.addEventListener('change', function() {
                    calendar.refetchEvents();
                });
            }

            window.resetFilters = function() {
                if (filterMedecin) filterMedecin.value = '';
                if (filterStatut) filterStatut.value = '';
                calendar.refetchEvents();
            };

            // ========== FONCTIONS UTILITAIRES ==========
            function formatDate(date) {
                if (!date) return '-';
                var options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                return date.toLocaleDateString('fr-FR', options);
            }

            function formatDateShort(date) {
                if (!date) return '-';
                var options = {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long'
                };
                return date.toLocaleDateString('fr-FR', options);
            }

            function getStatusBadge(statut) {
                var colors = {
                    'En attente': 'warning',
                    'Confirmé': 'success',
                    'Annulé': 'danger',
                    'Terminé': 'info'
                };
                var color = colors[statut] || 'secondary';
                return '<span class="badge bg-' + color + ' fs-6">' + statut + '</span>';
            }

            function updateStats(events) {
                var today = new Date();
                today.setHours(0, 0, 0, 0);

                var endOfWeek = new Date(today);
                endOfWeek.setDate(endOfWeek.getDate() + 7);

                var todayCount = 0;
                var weekCount = 0;
                var pendingCount = 0;
                var confirmedCount = 0;

                events.forEach(function(evt) {
                    var evtDate = new Date(evt.start);
                    evtDate.setHours(0, 0, 0, 0);

                    var statut = evt.extendedProps ? evt.extendedProps.statut : evt.statut;

                    if (evtDate.getTime() === today.getTime()) {
                        todayCount++;
                    }
                    if (evtDate >= today && evtDate < endOfWeek) {
                        weekCount++;
                    }
                    if (statut === 'En attente') {
                        pendingCount++;
                    }
                    if (statut === 'Confirmé') {
                        confirmedCount++;
                    }
                });

                document.getElementById('stat-today').textContent = todayCount;
                document.getElementById('stat-week').textContent = weekCount;
                document.getElementById('stat-pending').textContent = pendingCount;
                document.getElementById('stat-confirmed').textContent = confirmedCount;
            }
        });
    </script>
}
