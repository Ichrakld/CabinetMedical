@model IEnumerable<GestionCabinetMedical.Models.RendezVou>

@{
    ViewData["Title"] = "Gestion des Rendez-vous";
    var isPatient = (bool)(ViewBag.IsPatient ?? false);
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-calendar-alt text-primary me-2"></i>
            @(isPatient ? "Mes Rendez-vous" : "Gestion des Rendez-vous")
        </h2>
        <div>
            <a asp-action="Calendrier" class="btn btn-outline-info me-2"><i class="fas fa-calendar"></i> Calendrier</a>
            @if (!isPatient)
            {
                <a asp-action="ExportExcel" class="btn btn-success me-2"
                   asp-route-search="@ViewBag.CurrentSearch"
                   asp-route-statut="@ViewBag.CurrentStatut"
                   asp-route-dateDebut="@ViewBag.DateDebut"
                   asp-route-dateFin="@ViewBag.DateFin"
                   asp-route-periode="@ViewBag.Periode">
                    <i class="fas fa-file-excel"></i> Exporter
                </a>
                <a asp-action="Create" class="btn btn-primary"><i class="fas fa-plus"></i> Nouveau RDV</a>
            }
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (isPatient)
    {
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>Vous consultez uniquement vos propres rendez-vous.
        </div>
    }

    @if (!isPatient)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form asp-action="Index" method="get">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label"><i class="fas fa-search"></i> Recherche</label>
                            <input type="text" name="search" class="form-control" placeholder="Patient ou médecin..." value="@ViewBag.CurrentSearch">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label"><i class="fas fa-filter"></i> Statut</label>
                            <select name="statut" class="form-select">
                                <option value="">Tous</option>
                                <option value="En attente" selected="@(ViewBag.CurrentStatut == "En attente")">En attente</option>
                                <option value="Confirmé" selected="@(ViewBag.CurrentStatut == "Confirmé")">Confirmé</option>
                                <option value="Annulé" selected="@(ViewBag.CurrentStatut == "Annulé")">Annulé</option>
                                <option value="Terminé" selected="@(ViewBag.CurrentStatut == "Terminé")">Terminé</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label"><i class="fas fa-clock"></i> Période</label>
                            <select name="periode" class="form-select">
                                <option value="">Toutes</option>
                                <option value="aujourd'hui" selected="@(ViewBag.Periode == "aujourd'hui")">Aujourd'hui</option>
                                <option value="semaine" selected="@(ViewBag.Periode == "semaine")">Cette semaine</option>
                                <option value="mois" selected="@(ViewBag.Periode == "mois")">Ce mois</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Date début</label>
                            <input type="date" name="dateDebut" class="form-control" value="@ViewBag.DateDebut">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Date fin</label>
                            <input type="date" name="dateFin" class="form-control" value="@ViewBag.DateFin">
                        </div>
                        <div class="col-md-1">
                            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    }

    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Date & Heure</th>
                        <th>Patient</th>
                        <th>Médecin</th>
                        <th>Motif</th>
                        <th>Statut</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Aucun rendez-vous trouvé</h5>
                            </td>
                        </tr>
                    }
                    else
                    {
                        foreach (var rdv in Model)
                        {
                            var isPast = rdv.DateHeure < DateTime.Now;
                            var badgeClass = rdv.Statut == "Confirmé" ? "bg-success" :
                            rdv.Statut == "Annulé" ? "bg-danger" :
                            rdv.Statut == "Terminé" ? "bg-info" : "bg-warning text-dark";
                            <tr class="@(isPast && rdv.Statut != "Annulé" ? "table-secondary" : "")">
                                <td><strong>@rdv.NumCom</strong></td>
                                <td>
                                    <i class="fas fa-calendar text-primary me-1"></i>
                                    @rdv.DateHeure.ToString("dd/MM/yyyy")
                                    <br><small class="text-muted"><i class="fas fa-clock"></i> @rdv.DateHeure.ToString("HH:mm")</small>
                                </td>
                                <td>
                                    <strong>@rdv.Patient?.IdNavigation?.Nom @rdv.Patient?.IdNavigation?.Prenom</strong>
                                </td>
                                <td>
                                    <span class="text-primary">Dr. @rdv.Medecin?.IdNavigation?.Nom</span>
                                    <br><small class="text-muted">@rdv.Medecin?.Specialite</small>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(rdv.Motif))
                                    {
                                        <small>@(rdv.Motif.Length > 30 ? rdv.Motif.Substring(0, 30) + "..." : rdv.Motif)</small>
                                    }
                                    else
                                    {
                                        <small class="text-muted">-</small>
                                    }
                                </td>
                                <td><span class="badge @badgeClass">@rdv.Statut</span></td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <a asp-action="Details" asp-route-id="@rdv.NumCom" class="btn btn-outline-info" title="Détails">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        @if (!isPatient)
                                        {
                                            <a asp-action="Edit" asp-route-id="@rdv.NumCom" class="btn btn-outline-warning" title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            @if (rdv.Statut == "En attente")
                                            {
                                                <button class="btn btn-outline-success btn-confirm" data-id="@rdv.NumCom" title="Confirmer">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            }
                                            @if (rdv.Statut != "Annulé" && rdv.Statut != "Terminé")
                                            {
                                                <button class="btn btn-outline-danger btn-cancel" data-id="@rdv.NumCom" title="Annuler">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            }
                                            <a asp-action="Delete" asp-route-id="@rdv.NumCom" class="btn btn-outline-danger" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        @if (ViewBag.TotalPages > 1)
        {
            <div class="card-footer">
                <nav>
                    <ul class="pagination justify-content-center mb-0">
                        @for (int i = 1; i <= ViewBag.TotalPages; i++)
                        {
                            <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                <a class="page-link" asp-action="Index" asp-route-page="@i"
                                   asp-route-search="@ViewBag.CurrentSearch" asp-route-statut="@ViewBag.CurrentStatut">@i</a>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('.btn-confirm').click(function() {
                var id = $(this).data('id');
                if (confirm('Confirmer ce rendez-vous ?')) {
                    $.post('/RendezVous/ConfirmRdv/' + id, function(r) { if (r.success) location.reload(); });
                }
            });
            $('.btn-cancel').click(function() {
                var id = $(this).data('id');
                var raison = prompt('Raison (optionnel):');
                $.post('/RendezVous/CancelRdv/' + id + '?raison=' + encodeURIComponent(raison || ''), function(r) { if (r.success) location.reload(); });
            });
        });
    </script>
}
